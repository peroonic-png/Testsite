<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lautst√§rke-Roboter-Monitor</title>
    <!-- Tailwind CSS laden -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Konfiguration f√ºr Tailwind CSS (mit Inter Schriftart) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'robot-blue': '#4c7cff',
                        'robot-dark': '#1e3a8a',
                        'graph-green': '#34d399',
                        'alert-red': '#f87171',
                    }
                }
            }
        }
    </script>
    <style>
        /* Zus√§tzliche Stile f√ºr Canvas und Animation */
        body {
            background-color: #f1f5f9; /* Helles Blau-Grau */
            font-family: 'Inter', sans-serif;
        }
        .monitor-card {
            background-color: #ffffff;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 4px solid #4c7cff;
            max-width: 90%;
        }
        #chartCanvas {
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            border-radius: 0.5rem;
        }
        .button-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .button-shadow:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        /* Roboter-SVG-Animation f√ºr Wut */
        .angry-mouth {
            transition: transform 0.2s;
            transform-origin: center;
        }
        .robot-angry .angry-mouth {
            transform: translateY(-2px) scaleX(1.1);
        }
        .robot-angry .angry-brows {
            transform: translateY(2px);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Haupt-Monitor-Karte -->
    <div id="monitor" class="monitor-card p-6 md:p-10 rounded-xl w-full max-w-4xl flex flex-col items-center">
        <h1 class="text-3xl md:text-4xl font-extrabold text-robot-dark mb-6">LAUTST√ÑRKE MONITOR 2000</h1>
        
        <div class="flex flex-col md:flex-row w-full gap-8">
            
            <!-- Linke Seite: Roboter und Nachrichten -->
            <div class="w-full md:w-1/2 flex flex-col items-center">
                
                <!-- Roboter-Darstellung (SVG) -->
                <div id="robotContainer" class="relative w-48 h-48 md:w-64 md:h-64 mb-6 transition-all duration-300">
                    <!-- Das SVG des Roboters -->
                    <svg id="robot" class="w-full h-full" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <!-- K√∂rper und Kopf (Blau/Wei√ü) -->
                        <rect x="25" y="10" width="50" height="70" rx="10" fill="#E0F2FE"/>
                        <rect x="30" y="15" width="40" height="50" rx="5" fill="#ffffff"/>
                        <!-- Monitor (Auge) -->
                        <rect x="35" y="20" width="30" height="25" rx="3" fill="#34D399"/>
                        
                        <!-- Augenbrauen (Wut-Indikator) -->
                        <!-- Linke Braue -->
                        <path id="leftBrow" class="angry-brows transition-transform duration-200" d="M35 25 L45 25 L40 28 Z" fill="#EF4444"/>
                        <!-- Rechte Braue -->
                        <path id="rightBrow" class="angry-brows transition-transform duration-200" d="M65 25 L55 25 L60 28 Z" fill="#EF4444"/>
                        
                        <!-- Mund (Pscht/L√§cheln) -->
                        <rect id="robotMouth" x="42" y="50" width="16" height="4" rx="2" fill="#1E3A8A"/>

                        <!-- Arme und Tracks -->
                        <rect x="15" y="30" width="10" height="30" rx="5" fill="#4C7CFF"/>
                        <rect x="75" y="30" width="10" height="30" rx="5" fill="#4C7CFF"/>
                        <rect x="20" y="75" width="60" height="10" rx="5" fill="#4C7CFF"/>
                    </svg>

                    <!-- Pscht! Sprechblase -->
                    <div id="pschtBubble" class="absolute -top-10 -right-5 bg-alert-red text-white font-bold p-3 rounded-xl shadow-lg transform scale-0 transition-transform duration-300 opacity-0 text-lg md:text-xl" style="min-width: 120px; text-align: center;">
                        PSCHTT!
                    </div>
                </div>

                <!-- Status-Nachricht -->
                <div id="statusMessage" class="h-10 text-xl font-semibold text-center text-gray-700">
                    Bereit zum Starten.
                </div>
            </div>

            <!-- Rechte Seite: Graph und Lautst√§rkeanzeige -->
            <div class="w-full md:w-1/2 flex flex-col">
                <div class="mb-6 flex justify-center">
                    <!-- Lautst√§rkeanzeige (Simuliert) -->
                    <div class="relative w-48 h-24">
                        <div class="w-48 h-24 rounded-full border-4 border-gray-300"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-4xl" role="img" aria-label="Lautsprecher">üîä</span>
                        </div>
                        <div class="absolute top-0 left-1/2 -ml-0.5 w-1 h-24 transform origin-bottom rotate-45 transition-transform duration-100" style="background-color: #EF4444; transform: rotate(-135deg);" id="volumeNeedle"></div>
                        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-4 h-4 bg-gray-900 rounded-full"></div>
                        <span class="absolute top-0 left-0 text-sm font-bold text-graph-green">Leise (0)</span>
                        <span class="absolute top-0 right-0 text-sm font-bold text-alert-red">Laut (100)</span>
                        <span id="dBDisplay" class="absolute bottom-0 left-1/2 transform -translate-x-1/2 text-lg font-bold text-gray-800">0 dB</span>
                    </div>
                </div>

                <!-- Graph-Canvas -->
                <canvas id="chartCanvas" class="w-full h-48 md:h-64"></canvas>
            </div>
        </div>

        <!-- Buttons -->
        <div class="mt-8 flex gap-4">
            <button id="startButton" class="button-shadow bg-graph-green hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full text-xl" disabled>
                Start Messung
            </button>
            <button id="stopButton" class="button-shadow bg-alert-red hover:bg-red-600 text-white font-bold py-3 px-8 rounded-full text-xl" disabled>
                Stop Messung
            </button>
        </div>

        <!-- Warnhinweis f√ºr HTTPS / Mikrofon -->
        <p class="mt-6 text-sm text-gray-500 text-center">
            Hinweis: Das Mikrofon funktioniert nur √ºber eine sichere Verbindung (HTTPS). Bei lokalen Dateien kann es zu Problemen kommen.
        </p>

    </div>

    <script type="module">
        // Element-Referenzen
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const statusMessage = document.getElementById('statusMessage');
        const chartCanvas = document.getElementById('chartCanvas');
        const volumeNeedle = document.getElementById('volumeNeedle');
        const dBDisplay = document.getElementById('dBDisplay');
        const pschtBubble = document.getElementById('pschtBubble');
        const robotContainer = document.getElementById('robotContainer');
        const robotMouth = document.getElementById('robotMouth');
        const leftBrow = document.getElementById('leftBrow');
        const rightBrow = document.getElementById('rightBrow');

        // Audio-Konfiguration
        let audioContext;
        let analyser;
        let mediaStreamSource;
        let animationFrameId;
        let isMeasuring = false;

        // Graph-Konfiguration
        const ctx = chartCanvas.getContext('2d');
        let dataPoints = [];
        const maxDataPoints = 60; // Anzahl der Punkte im Graphen

        // Schwellenwerte f√ºr Roboter-Reaktionen
        const WARNING_LEVEL = 40; // Ab dieser Lautst√§rke wird der Roboter nerv√∂s
        const ANGRY_LEVEL = 60;   // Ab dieser Lautst√§rke wird der Roboter w√ºtend

        /**
         * Roboter-Mund und Brauen zur√ºcksetzen (neutral)
         */
        function resetRobot() {
            robotContainer.classList.remove('robot-angry');
            pschtBubble.classList.remove('scale-100', 'opacity-100');
            pschtBubble.classList.add('scale-0', 'opacity-0');
            robotMouth.setAttribute('fill', '#1E3A8A'); // Standardmund
            leftBrow.setAttribute('fill', 'transparent');
            rightBrow.setAttribute('fill', 'transparent');
        }
        
        /**
         * Roboter sauer machen und pscht sagen lassen
         */
        function makeRobotAngry(level) {
            // Nur Pscht zeigen, wenn der Roboter sehr w√ºtend ist
            if (level >= ANGRY_LEVEL && !pschtBubble.classList.contains('scale-100')) {
                pschtBubble.classList.remove('scale-0', 'opacity-0');
                pschtBubble.classList.add('scale-100', 'opacity-100');
                robotMouth.setAttribute('fill', '#EF4444'); // Roter Mund
            } else if (level < ANGRY_LEVEL && pschtBubble.classList.contains('scale-100')) {
                // Pscht Blase ausblenden, wenn die Lautst√§rke sinkt
                pschtBubble.classList.remove('scale-100', 'opacity-100');
                pschtBubble.classList.add('scale-0', 'opacity-0');
                robotMouth.setAttribute('fill', '#1E3A8A'); // Normaler Mund
            }
            
            // Roboter-Klasse f√ºr allgemeine Wut-Animation hinzuf√ºgen/entfernen
            if (level >= WARNING_LEVEL) {
                robotContainer.classList.add('robot-angry');
                leftBrow.setAttribute('fill', '#EF4444');
                rightBrow.setAttribute('fill', '#EF4444');
            } else {
                robotContainer.classList.remove('robot-angry');
                leftBrow.setAttribute('fill', 'transparent');
                rightBrow.setAttribute('fill', 'transparent');
            }
        }
        
        /**
         * Initialisiert das Mikrofon und die Audio-Verarbeitung.
         */
        async function initAudio() {
            try {
                // Zugriff auf das Mikrofon anfordern
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Audio-Kontext und Analysator initialisieren
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048; // Gro√üe FFT-Gr√∂√üe f√ºr bessere Analyse
                
                // Stream-Quelle erstellen und mit Analysator verbinden
                mediaStreamSource = audioContext.createMediaStreamSource(stream);
                mediaStreamSource.connect(analyser);

                startButton.disabled = false;
                statusMessage.textContent = "Mikrofon erfolgreich verbunden. Dr√ºcke 'Start Messung'.";
                
            } catch (err) {
                console.error('Fehler beim Zugriff auf das Mikrofon:', err);
                statusMessage.textContent = `Fehler: Mikrofonzugriff verweigert oder nicht verf√ºgbar. ${err.name}`;
            }
        }

        /**
         * Zeichnet den Graphen auf das Canvas.
         */
        function drawChart() {
            // Gr√∂√üe des Canvas auf die Display-Gr√∂√üe setzen
            const width = chartCanvas.width;
            const height = chartCanvas.height;

            // Canvas leeren
            ctx.clearRect(0, 0, width, height);

            // Gitterlinien zeichnen (Horizontal)
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            for (let i = 1; i < 5; i++) {
                ctx.beginPath();
                ctx.moveTo(0, height * i / 5);
                ctx.lineTo(width, height * i / 5);
                ctx.stroke();
            }

            // Graphenlinie zeichnen
            ctx.beginPath();
            ctx.strokeStyle = '#34d399';
            ctx.lineWidth = 3;

            const sliceWidth = width / (maxDataPoints - 1);
            let x = 0;

            for (let i = 0; i < dataPoints.length; i++) {
                const value = dataPoints[i];
                // Wert (0-100) auf Canvas-H√∂he (0-height) skalieren
                const y = height - (value / 100) * height; 

                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }

                x += sliceWidth;
            }
            ctx.stroke();
        }

        /**
         * Haupt-Animations- und Messschleife.
         */
        function updateVolume() {
            // Buffer f√ºr Frequenzdaten (zum Messen der Lautst√§rke)
            const bufferLength = analyser.fftSize;
            const dataArray = new Uint8Array(bufferLength);
            
            // Frequenzdaten in den Array kopieren
            analyser.getByteFrequencyData(dataArray);

            // RMS (Root Mean Square) berechnen, um die Lautst√§rke zu sch√§tzen
            let sumOfSquares = 0;
            for (let i = 0; i < bufferLength; i++) {
                sumOfSquares += dataArray[i] * dataArray[i];
            }
            // Der resultierende Wert liegt zwischen 0 (Stille) und ~100 (Maximum)
            const rms = Math.sqrt(sumOfSquares / bufferLength);

            // Normalisierung auf einen Wert von 0 bis 100 f√ºr die Anzeige
            // Eine einfache Normalisierung des RMS-Wertes reicht hier aus
            let normalizedVolume = Math.min(100, Math.round(rms * (100 / 50))); // Skaliere den RMS-Wert auf max 100

            // Datenpunkt hinzuf√ºgen und alte Punkte entfernen
            dataPoints.push(normalizedVolume);
            if (dataPoints.length > maxDataPoints) {
                dataPoints.shift();
            }

            // Lautst√§rkeanzeige (Nadel) aktualisieren
            // 0 dB = -135 Grad, 100 dB = +45 Grad (gesamt 180 Grad)
            const angle = -135 + (normalizedVolume * 1.8);
            volumeNeedle.style.transform = `rotate(${angle}deg)`;
            dBDisplay.textContent = `${normalizedVolume} dB`; // Zeige den normalisierten Wert als dB

            // Roboter-Reaktionen ausl√∂sen
            makeRobotAngry(normalizedVolume);
            
            // Graphen neu zeichnen
            drawChart();

            // Schleife fortsetzen
            if (isMeasuring) {
                animationFrameId = requestAnimationFrame(updateVolume);
            }
        }

        /**
         * Start-Button-Handler
         */
        startButton.addEventListener('click', () => {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            isMeasuring = true;
            startButton.disabled = true;
            stopButton.disabled = false;
            statusMessage.textContent = "Messung l√§uft... Sei leise, oder der Roboter wird b√∂se!";
            resetRobot();
            updateVolume();
        });

        /**
         * Stop-Button-Handler
         */
        stopButton.addEventListener('click', () => {
            isMeasuring = false;
            cancelAnimationFrame(animationFrameId);
            startButton.disabled = false;
            stopButton.disabled = true;
            statusMessage.textContent = "Messung gestoppt. Dr√ºcke 'Start Messung' f√ºr eine neue Messung.";
            // Graph-Daten zur√ºcksetzen
            dataPoints = [];
            drawChart();
            resetRobot();
            // Nadel und Anzeige zur√ºcksetzen
            volumeNeedle.style.transform = `rotate(-135deg)`;
            dBDisplay.textContent = `0 dB`;
        });
        
        // Initialisiere die Audio-Komponenten, sobald das Fenster geladen ist
        window.onload = () => {
             // Setze die Canvas-Gr√∂√üe basierend auf dem Container
            chartCanvas.width = chartCanvas.offsetWidth;
            chartCanvas.height = chartCanvas.offsetHeight;
            initAudio();
        };

        // Responsivit√§t: Canvas bei Gr√∂√üen√§nderung des Fensters neu dimensionieren und zeichnen
        window.addEventListener('resize', () => {
            chartCanvas.width = chartCanvas.offsetWidth;
            chartCanvas.height = chartCanvas.offsetHeight;
            drawChart(); // Graphen neu zeichnen, um die Skalierung zu korrigieren
        });

    </script>

</body>
</html>

